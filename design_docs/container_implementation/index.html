<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.20.5" />
    <meta name="description" content="">


    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />

    
    <title>Container Implementation</title>
    <link href="http://clipper.ai//css/nucleus.css" rel="stylesheet">
    <link href="http://clipper.ai//css/font-awesome.min.css" rel="stylesheet">
    <link href="http://clipper.ai//css/hybrid.css" rel="stylesheet">
    <link href="http://clipper.ai//css/featherlight.min.css" rel="stylesheet">
    <link href="http://clipper.ai//css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="http://clipper.ai//css/horsey.css" rel="stylesheet">
    <link href="http://clipper.ai//css/theme.css" rel="stylesheet">
    <link href="http://clipper.ai//css/hugo-theme.css" rel="stylesheet">
    <script src="http://clipper.ai//js/jquery-2.x.min.js"></script>
    <style type="text/css">:root #header + #content > #left > #rlblock_left
    {display:none !important;}</style>
    

  </head>
  <body class="" data-url="/design_docs/container_implementation/">
    
    <nav id="sidebar">
  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="http://clipper.ai">
  <img id="grav-logo" src="/images/clipper-logo.png">
  </img>
</a>

    </div>
    
</div>


  <div class="highlightable">
    <ul class="topics">
      
        
        
          
          
            
          
        
          
          
            
          
        
          
          
            
          
        
          
          
            
          
        
          
          
            
          
        
          
          
            
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
      
      

      
      
      
        
          
        
      
      
      

      <li class="dd-item  " data-nav-id="/overview/">
        <a href="/overview/">
          <span>
            
              <b>1. </b>
            
             Getting Started
            
           </span>
        </a>
        
        <ul>
          
            <li class="dd-item " data-nav-id="/overview/quickstart/">
              <a href="/overview/quickstart/">
                <span>Quickstart     </i></span>
              </a>
            </li>
          
            <li class="dd-item " data-nav-id="/overview/tutorial/">
              <a href="/overview/tutorial/">
                <span>Image Classification Tutorial     </i></span>
              </a>
            </li>
          
        </ul>
        
      </li>
      
      
      

      
      
      
        
          
        
      
      
      

      <li class="dd-item  " data-nav-id="/querying_clipper/">
        <a href="/querying_clipper/">
          <span>
            
              <b>2. </b>
            
             Querying Clipper
            
           </span>
        </a>
        
      </li>
      
      
      

      
      
      
        
          
        
      
      
      

      <li class="dd-item  " data-nav-id="/documentation/">
        <a href="/documentation/">
          <span>
            
              <b>3. </b>
            
             Documentation
            
           </span>
        </a>
        
        <ul>
          
            <li class="dd-item " data-nav-id="/documentation/clipper_manager/">
              <a href="/documentation/clipper_manager/">
                <span>Managing a Clipper Instance     </i></span>
              </a>
            </li>
          
            <li class="dd-item " data-nav-id="/documentation/python_model_deployment/">
              <a href="/documentation/python_model_deployment/">
                <span>Python Model Deployment     </i></span>
              </a>
            </li>
          
        </ul>
        
      </li>
      
      
      

      
      
      
        
          
        
      
      
      

      <li class="dd-item  " data-nav-id="/contributing/">
        <a href="/contributing/">
          <span>
            
              <b>4. </b>
            
             Contributing
            
           </span>
        </a>
        
      </li>
      
      
      

      
      
      
        
          
        
      
      
      

      <li class="dd-item  " data-nav-id="/roadmap/">
        <a href="/roadmap/">
          <span>
            
              <b>5. </b>
            
             Status and Roadmap
            
           </span>
        </a>
        
      </li>
      
      
      

      
      
      
        
          
        
      
      
      

      <li class="dd-item  parent" data-nav-id="/design_docs/">
        <a href="/design_docs/">
          <span>
            
              <b>6. </b>
            
             Additional Resources
            
           </span>
        </a>
        
        <ul>
          
            <li class="dd-item active" data-nav-id="/design_docs/container_implementation/">
              <a href="/design_docs/container_implementation/">
                <span>Container Implementation     </i></span>
              </a>
            </li>
          
        </ul>
        
      </li>
      
      
    </ul>
    <hr>
     
    <section id="footer">
      <p>Built with <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>

        <section id="body">
        <div id="overlay"></div>

        <div class="padding highlightable">

            <div id="top-bar">
              
              <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                  <span id="sidebar-toggle-span">
                      <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                        <i class="fa fa-bars"></i>
                      </a>
                  </span>
                
                <span id="toc-menu"><a href=""><i class="fa fa-list-alt"></i></a></span>
                
                
                  
                  
                  
                    
                    
                <a href="/design_docs/" itemprop="url"><span itemprop="title">Additional Resources</span></a> <i class="fa fa-angle-right"></i>
                    
                  
                
                <span itemprop="title"> Container Implementation</span>
              </div>
              
                  <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#container-implementation-details">Container Implementation Details</a>
<ul>
<li><a href="#socket-creation">Socket Creation</a></li>
<li><a href="#initializing-a-connection">Initializing a Connection</a></li>
<li><a href="#serialization-formats">Serialization Formats</a>
<ul>
<li><a href="#serializing-prediction-requests">Serializing Prediction Requests</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

              

            </div>
            
              <div id="body-inner">
                
                <h1>Container Implementation</h1>
                



<h2 id="container-implementation-details">Container Implementation Details</h2>

<p>The following is relevant for the implementation of model containers in different languages.
Model containers must implement functionality consistent with this information.</p>

<h3 id="socket-creation">Socket Creation</h3>

<ul>
<li><p>Create a <a href="http://api.zeromq.org/3-2:zmq-socket">ZeroMQ Dealer socket</a>. This socket can receive requests and send responses asynchronously.</p>

<ul>
<li>Python example:
<br /></li>
</ul>

<pre><code>import zmq
context = zmq.Context();
socket = context.socket(zmq.DEALER)
</code></pre></li>
</ul>

<h3 id="initializing-a-connection">Initializing a Connection</h3>

<ol>
<li><p>Once a ZeroMQ Dealer socket has been created, use it to connect to Clipper. In Python, this can be accomplished as follows:</p>

<pre><code>socket.connect(&lt;CLIPPER_TCP_ADDRESS&gt;, &lt;CLIPPER_PORT&gt;)
</code></pre></li>

<li><p>Then, send a series of ordered messages providing information about the model. This message should be preceded by an
<a href="http://zguide.zeromq.org/php:chapter3#The-Simple-Reply-Envelope">empty ZeroMQ frame</a>. The following attributes should then be sent in order:</p>

<ul>
<li><strong>Model Name</strong>: The user-defined name of the model, as a string</li>
<li><strong>Model Version</strong>: The <strong>integer</strong> model version. <strong>This should be sent as a string</strong>.</li>
<li><strong>Input Type</strong>: The type of input that the model should accept. This must be one of the following <strong>integer</strong> values, sent as a <strong>string</strong>:</li>
<li>0: Bytes</li>
<li>1: 32-bit Integers</li>
<li>2: 32-bit Floats</li>
<li>3: 64-bit Doubles</li>

<li><p>4: Strings</p></li>

<li><p>Python example:</p></li>
</ul>

<pre><code>socket.send(&quot;&quot;, zmq.SNDMORE); # Sends an empty frame and indicates that more content will follow
socket.send(&lt;MODEL_NAME&gt;, zmq.SNDMORE);
socket.send(str(&lt;MODEL_VERSION&gt;), zmq.SNDMORE);
socket.send(str(&lt;MODEL_INPUT_TYPE&gt;))
</code></pre></li>

<li><p>The socket should then be continually polled for requests from Clipper.</p>

<ul>
<li>Python example:
<br /></li>
</ul></li>
</ol>

<pre><code>  while True:
    # Receive empty frame that Clipper sends before every request
    socket.recv()
    # Receive the unique id associated with the request message
    msg_id_bytes = socket.recv()
    # Receive the request header
    request_header = socket.recv()
    # Process the request based on header data
    ...
</code></pre>

<h3 id="serialization-formats">Serialization Formats</h3>

<p>RPC requests sent from Clipper to model containers are divided into two categories: <strong>Prediction Requests</strong> and <strong>Feedback Requests</strong>. Each request type has a specific serialization format that defines the container deserialization procedure.</p>

<h4 id="serializing-prediction-requests">Serializing Prediction Requests</h4>

<ol>
<li><p>All requests begin with a 32-bit integer header, sent as a single ZeroMQ message. The value of this integer will be 0, indicating that the request is a prediction request.</p></li>

<li><p>The next ZeroMQ message contains an input header. This is a list of 32-bit integers.</p>

<ul>
<li><p>The input header begins with a 32-bit integer specifying the type of inputs contained in the request. This integer can assume values 0-4, as defined in point 2 of <strong>Initializing a Connection</strong>.</p></li>

<li><p>The next 32-bit integer in the input header is the number of inputs included in the serialized content.</p></li>

<li><p>The remaining values in the input header correspond to the offsets at which the deserialized output should be split.</p></li>

<li><p>For example, if the request contains three double vectors of size 500, the offsets will be <code>[500, 1000]</code>, indicating that the deserialized vector of 1500 doubles should be split into three vectors containing doubles 0-499, 500-999, and 1000-1499 respectively.</p></li>

<li><p>In the case of strings, the offset list is not relevant and should not be used.</p></li>
</ul></li>

<li><p>The final ZeroMQ message contains the concatenation of all inputs, represented as a string of bytes. This string of bytes should be converted to an array of the type specified by the input header.</p>

<ul>
<li>In the case of primitive inputs (types 0-3), deserialized inputs can then be obtained by splitting the typed array at the offsets specified in the input header.</li>
<li>Python example:
<br /></li>
</ul>

<pre><code> raw_concatenated_content = socket.recv()
 typed_inputs = np.frombuffer(raw_concatenated_content, dtype=&lt;PRIMITIVE_INPUT_TYPE&gt;)
 inputs = np.split(typed_inputs, &lt;OFFSETS_LIST&gt;)
</code></pre>

<ul>
<li>In the case of string inputs (type 4), all strings are sent with trailing null terminators. Therefore, deserialized inputs can be obtaining by splitting the typed array along the null terminator character, <code>\0</code>.</li>
<li>Python example:
<br /></li>
</ul>

<pre><code> raw_concatenated_content = socket.recv()
 # Split content based on trailing null terminators
 # Ignore the extraneous final null terminator by using a -1 slice
 inputs = np.array(raw_concatenated_content.split('\0')[:-1], dtype=np.string_)
</code></pre></li>
</ol>

<div class="notices info" ><p>For additional deserialization references, check out the <a href="https://github.com/ucbrise/clipper/blob/develop/containers/python/rpc.py">Python RPC client</a></p>
</div>



      
      
      </div>
    </div>

    

    <div id="navigation">
        
        
        
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="http://clipper.ai//js/clipboard.min.js"></script>
    <script src="http://clipper.ai//js/perfect-scrollbar.min.js"></script>
    <script src="http://clipper.ai//js/perfect-scrollbar.jquery.min.js"></script>
    <script src="http://clipper.ai//js/jquery.sticky-kit.min.js"></script>
    <script src="http://clipper.ai//js/featherlight.min.js"></script>
    <script src="http://clipper.ai//js/html5shiv-printshiv.min.js"></script>
    <script src="http://clipper.ai//js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="http://clipper.ai//js/modernizr.custom.71422.js"></script>
    <script src="http://clipper.ai//js/learn.js"></script>
    <script src="http://clipper.ai//js/hugo-learn.js"></script>
    
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-99816998-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


  </body>
</html>

